// Modul EasyPieChart menggunakan IIFE (Immediately Invoked Function Expression)
!function(global, factory) {
    // Dukungan untuk AMD (Asynchronous Module Definition)
    if (typeof define === "function" && define.amd) {
        define(["jquery"], function(jQuery) {
            return factory(jQuery);
        });
    // Dukungan untuk Node.js atau CommonJS
    } else if (typeof exports === "object") {
        module.exports = factory(require("jquery"));
    // Jika tidak ada module loader, gunakan global `jQuery`
    } else {
        factory(jQuery);
    }
}(this, function($) { // Parameter `this` adalah `global` (window), dan `$` adalah jQuery

    // Kelas utama untuk EasyPieChart
    var EasyPieChart = function(el, options) {
        // Pengaturan default untuk grafik lingkaran
        var defaultOptions = {
            barColor: "#ef1e25",         // Warna progress lingkaran
            trackColor: "#f9f9f9",      // Warna latar belakang lingkaran
            scaleColor: "#dfe0e0",      // Warna indikator skala
            scaleLength: 5,             // Panjang indikator skala
            lineCap: "round",           // Ujung garis (bulat)
            lineWidth: 3,               // Ketebalan garis progress
            trackWidth: undefined,      // Ketebalan garis latar belakang (opsional)
            size: 110,                  // Ukuran lingkaran
            rotate: 0,                  // Rotasi grafik
            animate: {                  // Pengaturan animasi
                duration: 1000,         // Durasi animasi (ms)
                enabled: true           // Status animasi
            },
            // Fungsi easing untuk kelancaran animasi
            easing: function(x, t, b, c, d) {
                return (t /= d / 2) < 1 ? c / 2 * t * t + b : -c / 2 * (--t * (t - 2) - 1) + b;
            },
            // Callback saat animasi dimulai
            onStart: function(from, to) {},
            // Callback saat animasi berjalan
            onStep: function(from, to, currentValue) {},
            // Callback saat animasi selesai
            onStop: function(from, to) {}
        };

        // Inisialisasi elemen dan opsi
        this.el = el; 
        this.options = $.extend({}, defaultOptions, options);

        // Inisialisasi renderer (Canvas atau SVG)
        this.renderer = new this.options.renderer(this.el, this.options);

        // Gambar grafik pada posisi awal (0%)
        this.renderer.draw(0);

        // Simpan nilai saat ini
        this.currentValue = 0;

        // Cek atribut data-percent pada elemen HTML
        if (this.el.dataset && this.el.dataset.percent) {
            this.update(parseFloat(this.el.dataset.percent));
        } else if (this.el.getAttribute && this.el.getAttribute("data-percent")) {
            this.update(parseFloat(this.el.getAttribute("data-percent")));
        }
    };

    // Fungsi untuk memperbarui nilai grafik
    EasyPieChart.prototype.update = function(percent) {
        percent = parseFloat(percent);
        if (this.options.animate.enabled) {
            this.renderer.animate(this.currentValue, percent); // Jalankan animasi
        } else {
            this.renderer.draw(percent); // Gambar langsung tanpa animasi
        }
        this.currentValue = percent; // Simpan nilai baru
        return this;
    };

    // Menonaktifkan animasi
    EasyPieChart.prototype.disableAnimation = function() {
        this.options.animate.enabled = false;
        return this;
    };

    // Mengaktifkan animasi
    EasyPieChart.prototype.enableAnimation = function() {
        this.options.animate.enabled = true;
        return this;
    };

    // Menambahkan EasyPieChart sebagai plugin jQuery
    $.fn.easyPieChart = function(options) {
        return this.each(function() {
            // Inisialisasi hanya jika belum ada data EasyPieChart
            if (!$.data(this, "easyPieChart")) {
                $.data(this, "easyPieChart", new EasyPieChart(this, options));
            }
        });
    };
});

// jQuery untuk mengatur animasi grafik ketika elemen terlihat di layar
jQuery(document).ready(function($) {
    // Fungsi untuk memulai animasi grafik
    function animateElements() {
        $('.pr-chart-ctrl').each(function() {
            var elementPos = $(this).offset().top; // Posisi elemen dari atas halaman
            var topOfWindow = $(window).scrollTop(); // Scroll yang sudah dilakukan
            var animate = $(this).data('animate'); // Cek apakah elemen sudah dianimasikan

            // Jika elemen terlihat di layar dan belum dianimasikan
            if (elementPos < topOfWindow + $(window).height() - 30 && !animate) {
                $(this).data('animate', true); // Tandai elemen sebagai "sudah dianimasikan"
                $(this).find('.pr-chart').easyPieChart({
                    size: 200,               // Ukuran grafik
                    barColor: '#889C29',     // Warna progress lingkaran
                    trackColor: '#D7D7D7',   // Warna latar belakang lingkaran
                    scaleColor: '#B0CA35',   // Warna indikator skala
                    scaleLength: 10,         // Panjang indikator skala
                    lineWidth: 10,           // Ketebalan garis progress
                    lineCap: 'square',       // Ujung garis (kotak)
                    onStep: function(from, to, percent) {
                        // Perbarui teks dengan nilai persentase saat ini
                        $(this.el).find('i').text(Math.round(percent) + '%');
                    }
                }).stop(); // Hentikan animasi jika ada animasi berjalan
            }
        });
    }

    // Jalankan animasi saat halaman dimuat
    animateElements();

    // Jalankan animasi setiap kali pengguna menggulir halaman
    $(window).scroll(animateElements);
});
